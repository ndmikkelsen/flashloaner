name: Performance

on:
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: "20"

jobs:
  benchmarks:
    name: Bot Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run performance benchmarks
        run: pnpm test -- --reporter=verbose bot/__tests__/integration/performance/

      - name: Run full test suite (timing)
        run: pnpm test -- --reporter=verbose 2>&1 | tee test-results.txt

      - name: Extract timing summary
        if: github.event_name == 'pull_request'
        id: timing
        run: |
          echo "## Performance Results" > perf-comment.md
          echo "" >> perf-comment.md
          echo "### Test Suite Timing" >> perf-comment.md
          echo '```' >> perf-comment.md
          tail -10 test-results.txt >> perf-comment.md
          echo '```' >> perf-comment.md
          echo "" >> perf-comment.md
          echo "### Benchmark Thresholds" >> perf-comment.md
          echo "| Benchmark | Threshold | Status |" >> perf-comment.md
          echo "|-----------|-----------|--------|" >> perf-comment.md
          echo "| 2-pool poll cycle | < 50ms | Passed |" >> perf-comment.md
          echo "| 10-pool poll cycle | < 100ms | Passed |" >> perf-comment.md
          echo "| 100 consecutive cycles | < 2s total | Passed |" >> perf-comment.md
          echo "| 1000 opportunity analyses | < 100ms total | Passed |" >> perf-comment.md
          echo "| Memory accumulation | None | Passed |" >> perf-comment.md

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: perf-comment.md

  gas-comparison:
    name: Solidity Gas Comparison
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run gas report
        run: forge test --gas-report 2>&1 | tee gas-report.txt
        env:
          FOUNDRY_PROFILE: ci

      - name: Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt
          retention-days: 30
