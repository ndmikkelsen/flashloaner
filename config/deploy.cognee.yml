# Kamal 2 deployment config for Cognee (semantic search + knowledge layer)
#
# Deploy:   kamal setup -c config/deploy.cognee.yml     (first time)
#           kamal deploy -c config/deploy.cognee.yml    (subsequent)
# Logs:     kamal app logs -c config/deploy.cognee.yml
# Status:   kamal details -c config/deploy.cognee.yml
#
# Standalone config — use -c, never -d cognee. Using -d appends a destination
# suffix to the kamal-proxy service name (flashloaner-cognee-web-cognee) which
# conflicts with the existing registration (flashloaner-cognee-web).
#
# This is a per-project Cognee instance (flashloaner).
# Slimmed down: API + PostgreSQL/pgvector only (no Neo4j, no Redis).

service: flashloaner-cognee

image: flashloaner/cognee

servers:
  - 10.10.20.138

registry:
  server: harbor.compute.lan
  username: admin
  password:
    - KAMAL_REGISTRY_PASSWORD

ssh:
  user: compute
  keys:
    - ~/.ssh/z3r0Layer-main

builder:
  arch: amd64
  dockerfile: .claude/docker/Dockerfile.cognee

proxy:
  host: flashloaner-cognee.apps.compute.lan
  app_port: 8000
  ssl: false
  forward_headers: true
  response_timeout: 300  # cognify builds knowledge graph via LLM — can exceed kamal-proxy default 60s
  healthcheck:
    interval: 5
    path: /health
    timeout: 5

env:
  clear:
    # Relational Database (PostgreSQL)
    DB_PROVIDER: postgres
    DB_HOST: flashloaner-cognee-db
    DB_PORT: 5432
    DB_NAME: cognee
    DB_USERNAME: cognee
    # Vector Database (pgvector — same PostgreSQL instance)
    VECTOR_DB_PROVIDER: pgvector
    VECTOR_DB_HOST: flashloaner-cognee-db
    VECTOR_DB_PORT: 5432
    VECTOR_DB_NAME: cognee
    VECTOR_DB_USERNAME: cognee
    # Graph Database (embedded — no Neo4j server needed)
    GRAPH_DATABASE_PROVIDER: kuzu
    # Embeddings
    EMBEDDING_MODEL: text-embedding-3-small
    EMBEDDING_DIMENSIONS: "1536"
    # Auth (disabled — internal network only)
    REQUIRE_AUTHENTICATION: "false"
    ENABLE_BACKEND_ACCESS_CONTROL: "false"
  secret:
    - DB_PASSWORD
    - VECTOR_DB_PASSWORD
    - RELATIONAL_DATABASE
    - VECTOR_DB_URL
    - LLM_API_KEY

accessories:
  db:
    image: pgvector/pgvector:pg17
    host: 10.10.20.138
    port: "5432:5432"
    env:
      clear:
        POSTGRES_USER: cognee
        POSTGRES_DB: cognee
      secret:
        - POSTGRES_PASSWORD
    directories:
      - /mnt/nfs/databases/flashloaner/cognee:/var/lib/postgresql/data
