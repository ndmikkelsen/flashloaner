---
phase: 03-bot-adaptation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/src/gas/ArbitrumGasEstimator.ts
  - bot/src/gas/index.ts
  - bot/src/detector/types.ts
autonomous: true

must_haves:
  truths:
    - "ArbitrumGasEstimator calls NodeInterface precompile to get L1+L2 gas breakdown"
    - "CostEstimate type includes optional l1DataFee field for Arbitrum L1 data costs"
    - "Gas estimator returns totalGas, l1Gas, l2Gas, baseFee, l1BaseFeeEstimate, and totalCostWei"
  artifacts:
    - path: "bot/src/gas/ArbitrumGasEstimator.ts"
      provides: "Arbitrum NodeInterface gas estimation wrapper"
      contains: "gasEstimateComponents"
    - path: "bot/src/gas/index.ts"
      provides: "Gas module barrel export"
      exports: ["estimateArbitrumGas", "ArbitrumGasComponents"]
    - path: "bot/src/detector/types.ts"
      provides: "Extended CostEstimate with l1DataFee"
      contains: "l1DataFee"
  key_links:
    - from: "bot/src/gas/ArbitrumGasEstimator.ts"
      to: "NodeInterface precompile"
      via: "ethers.Contract at 0xC8"
      pattern: "0x00000000000000000000000000000000000000C8"
    - from: "bot/src/detector/types.ts"
      to: "bot/src/gas/ArbitrumGasEstimator.ts"
      via: "CostEstimate.l1DataFee populated by ArbitrumGasEstimator"
      pattern: "l1DataFee"
---

<objective>
Create the ArbitrumGasEstimator module that calls Arbitrum's NodeInterface precompile (`0xC8`) to get dual-component gas estimates (L1 data fee + L2 execution cost), and extend the CostEstimate type to carry L1 data fee information.

Purpose: Arbitrum L1 data fees represent ~95% of total transaction cost. Without this estimator, the bot shows misleadingly profitable opportunities. This module provides the correct gas breakdown for BOT-04 and BOT-05.

Output: `bot/src/gas/ArbitrumGasEstimator.ts` module, updated `CostEstimate` type.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bot-adaptation/03-RESEARCH.md
@bot/src/detector/types.ts
@bot/src/detector/OpportunityDetector.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ArbitrumGasEstimator module with NodeInterface wrapper</name>
  <files>
    bot/src/gas/ArbitrumGasEstimator.ts
    bot/src/gas/index.ts
  </files>
  <action>
    **Create `bot/src/gas/ArbitrumGasEstimator.ts`:**

    1. Define the NodeInterface precompile address constant:
       ```typescript
       const NODE_INTERFACE_ADDRESS = "0x00000000000000000000000000000000000000C8";
       ```

    2. Define the ABI for `gasEstimateComponents` as a human-readable ABI string array (ethers.js v6 style):
       ```typescript
       const NODE_INTERFACE_ABI = [
         "function gasEstimateComponents(address to, bool contractCreation, bytes calldata data) view returns (uint64 gasEstimate, uint64 gasEstimateForL1, uint256 baseFee, uint256 l1BaseFeeEstimate)"
       ];
       ```

    3. Define the `ArbitrumGasComponents` interface:
       ```typescript
       export interface ArbitrumGasComponents {
         totalGas: bigint;           // Total L1+L2 gas units
         l1Gas: bigint;              // L1 data component (~95% of total)
         l2Gas: bigint;              // L2 execution component (~5% of total)
         baseFee: bigint;            // Current L2 base fee (wei per gas)
         l1BaseFeeEstimate: bigint;  // L1 gas price estimate (wei)
         totalCostWei: bigint;       // Approximate total cost: totalGas * baseFee
       }
       ```

    4. Export an `estimateArbitrumGas` async function:
       ```typescript
       export async function estimateArbitrumGas(
         provider: Provider,
         to: string,
         data: string,
       ): Promise<ArbitrumGasComponents>
       ```
       - Create `new Contract(NODE_INTERFACE_ADDRESS, NODE_INTERFACE_ABI, provider)`.
       - Call `nodeInterface.gasEstimateComponents(to, false, data)`.
       - Extract `gasEstimate`, `gasEstimateForL1`, `baseFee`, `l1BaseFeeEstimate` from result.
       - Convert all to `bigint` via `BigInt(...)`.
       - Return `ArbitrumGasComponents` with computed `l2Gas = totalGas - l1Gas` and `totalCostWei = totalGas * baseFee`.

    5. Export a convenience function for converting gas components to ETH cost:
       ```typescript
       export function gasComponentsToEth(components: ArbitrumGasComponents): {
         totalCostEth: number;
         l1CostEth: number;
         l2CostEth: number;
       }
       ```
       - `totalCostEth = Number(components.totalCostWei) / 1e18`
       - `l1CostEth = Number(components.l1Gas * components.baseFee) / 1e18`
       - `l2CostEth = Number(components.l2Gas * components.baseFee) / 1e18`

    6. Add JSDoc with a source reference: `@see https://docs.arbitrum.io/build-decentralized-apps/how-to-estimate-gas`

    7. Import types from `ethers` (v6): `Contract` and `Provider`.

    **Create `bot/src/gas/index.ts`:**

    8. Barrel export file:
       ```typescript
       export { estimateArbitrumGas, gasComponentsToEth } from "./ArbitrumGasEstimator.js";
       export type { ArbitrumGasComponents } from "./ArbitrumGasEstimator.js";
       ```

    **Important:** Do NOT install `@arbitrum/sdk`. The raw ABI approach with ethers.js v6 is sufficient and avoids ethers v5/v6 conflicts.
  </action>
  <verify>
    1. `pnpm test` passes (no regressions — this is a new module, not modifying existing).
    2. TypeScript compiles: `npx tsc --noEmit` in the bot directory.
    3. Verify `bot/src/gas/ArbitrumGasEstimator.ts` exists and exports `estimateArbitrumGas`.
    4. Verify `bot/src/gas/index.ts` exists and re-exports the module.
  </verify>
  <done>
    `ArbitrumGasEstimator.ts` exists with `estimateArbitrumGas()` function that calls NodeInterface at `0xC8`, returns `ArbitrumGasComponents` with L1/L2 breakdown. `gas/index.ts` barrel export exists. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend CostEstimate type with l1DataFee field</name>
  <files>
    bot/src/detector/types.ts
  </files>
  <action>
    **In `bot/src/detector/types.ts`:**

    1. Add an optional `l1DataFee` field to the `CostEstimate` interface:
       ```typescript
       export interface CostEstimate {
         /** Flash loan fee in base token units (e.g. 0.05% of borrow) */
         flashLoanFee: number;
         /** Estimated gas cost in base token units (ETH) — L2 execution only */
         gasCost: number;
         /** Arbitrum L1 data posting cost in base token units (ETH). Only present on L2 chains. */
         l1DataFee?: number;
         /** Expected slippage loss in base token units */
         slippageCost: number;
         /** Total costs (includes l1DataFee when present) */
         totalCost: number;
       }
       ```

    2. Update the JSDoc comment on `gasCost` to clarify it represents "L2 execution cost" (to distinguish from L1 data fee).

    3. Update the JSDoc comment on `totalCost` to note it "includes l1DataFee when present".

    4. Do NOT change `OpportunityDetectorConfig` in this task. The `gasEstimatorFn` integration happens in Plan 03-03.

    **Why optional:** Making `l1DataFee` optional preserves backward compatibility. Existing code that creates `CostEstimate` objects (OpportunityDetector, tests) continues to work without changes. When the Arbitrum gas estimator is integrated in Plan 03-03, it will populate this field.
  </action>
  <verify>
    1. `pnpm test` passes — all 423 TypeScript tests pass without modification.
    2. TypeScript compiles without errors.
    3. Verify `CostEstimate` interface in `bot/src/detector/types.ts` has `l1DataFee?: number`.
  </verify>
  <done>
    `CostEstimate` has optional `l1DataFee` field with JSDoc explaining it's the Arbitrum L1 data posting cost. `gasCost` JSDoc clarified as L2-only. `totalCost` JSDoc notes L1 inclusion. All existing tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test` — all 423 TypeScript tests pass
2. `forge test` — all 312 Solidity tests pass (no Solidity changes)
3. `bot/src/gas/ArbitrumGasEstimator.ts` exists with `estimateArbitrumGas` function
4. `bot/src/gas/index.ts` barrel exports exist
5. `CostEstimate` in `bot/src/detector/types.ts` has `l1DataFee?: number`
6. TypeScript compiles without errors
</verification>

<success_criteria>
- ArbitrumGasEstimator calls NodeInterface at 0xC8 with correct ABI
- Returns ArbitrumGasComponents with totalGas, l1Gas, l2Gas, baseFee, l1BaseFeeEstimate, totalCostWei
- gasComponentsToEth convenience function converts bigint gas to ETH decimals
- CostEstimate.l1DataFee is optional (backward compatible)
- No new npm dependencies added
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-bot-adaptation/03-02-SUMMARY.md`
</output>
