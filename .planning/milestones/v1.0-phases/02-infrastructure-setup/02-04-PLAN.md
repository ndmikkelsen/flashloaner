---
phase: 02-infrastructure-setup
plan: 04
type: execute
wave: 2
depends_on: ["02-03"]
files_modified:
  - deployments/421614.json
autonomous: false
gap_closure: true

user_setup:
  - service: arbitrum-sepolia-testnet
    why: "Contract deployment requires funded wallet and private key"
    env_vars:
      - name: DEPLOYER_PRIVATE_KEY
        source: "Your wallet private key (MetaMask -> Account Details -> Export Private Key)"
      - name: BOT_WALLET_ADDRESS
        source: "Your bot wallet address (can be same as deployer for testnet)"
    dashboard_config:
      - task: "Fund deployer wallet with Arbitrum Sepolia testnet ETH"
        location: "Faucet: https://faucets.chain.link/arbitrum-sepolia OR https://www.alchemy.com/faucets/arbitrum-sepolia OR https://faucet.quicknode.com/arbitrum/sepolia"

must_haves:
  truths:
    - "FlashloanExecutor is deployed to Arbitrum Sepolia and has a valid contract address"
    - "CircuitBreaker and ProfitValidator are deployed to Arbitrum Sepolia"
    - "UniswapV2Adapter and UniswapV3Adapter are deployed to Arbitrum Sepolia"
    - "Deployment artifact exists at deployments/421614.json with all 5 contract addresses"
    - "Deploy.s.sol validation checks all pass (owner, botWallet, minProfit, adapters registered)"
  artifacts:
    - path: "deployments/421614.json"
      provides: "Arbitrum Sepolia deployment record with all contract addresses"
      contains: "FlashloanExecutor"
  key_links:
    - from: "deployments/421614.json"
      to: "contracts/script/Deploy.s.sol"
      via: "exportDeploymentAddresses function"
      pattern: "FlashloanExecutor.*CircuitBreaker.*ProfitValidator"
    - from: ".env.arbitrum-sepolia"
      to: "contracts/script/Deploy.s.sol"
      via: "vm.envAddress/vm.envUint calls"
      pattern: "AAVE_V3_POOL.*BALANCER_VAULT.*UNISWAP_V2_ROUTER"
---

<objective>
Deploy all contracts to Arbitrum Sepolia testnet and record deployment artifacts.

Purpose: The verification report found that Phase 2 completed infrastructure PREPARATION but not DEPLOYMENT. All 4 DEPLOY requirements (DEPLOY-01 through DEPLOY-04) are blocked because no `forge script --broadcast` was executed. This plan deploys FlashloanExecutor, CircuitBreaker, ProfitValidator, UniswapV2Adapter, and UniswapV3Adapter to Arbitrum Sepolia using the existing Deploy.s.sol script.

Output: `deployments/421614.json` with all 5 contract addresses, broadcast logs in `broadcast/`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan outputs
@.planning/phases/02-infrastructure-setup/02-02-SUMMARY.md
@.planning/phases/02-infrastructure-setup/02-03-SUMMARY.md

# Deployment infrastructure
@contracts/script/Deploy.s.sol
@.env.example.arbitrum-sepolia
@foundry.toml

# Reference deployment
@deployments/11155111.json
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: User prepares deployment wallet and environment</name>
  <what-built>
    Plans 02-01 and 02-02 prepared all deployment infrastructure:
    - `foundry.toml` has `arbitrum-sepolia` RPC endpoint
    - `.env.example.arbitrum-sepolia` has all required env vars with correct protocol addresses
    - `Deploy.s.sol` handles chainId 421614 and exports to `deployments/421614.json`
    - Plan 02-03 fixed the Balancer Vault placeholder to the real address
  </what-built>
  <how-to-verify>
    You need to:

    1. **Create your `.env.arbitrum-sepolia` file:**
       ```bash
       cp .env.example.arbitrum-sepolia .env.arbitrum-sepolia
       ```

    2. **Edit `.env.arbitrum-sepolia`** and fill in:
       - `DEPLOYER_PRIVATE_KEY` - Your wallet private key (prepend with `0x`)
       - `BOT_WALLET_ADDRESS` - Your bot wallet address (can be same as deployer for testnet)
       - Optionally: `ARBISCAN_API_KEY` for contract verification on Arbiscan

    3. **Fund your deployer wallet** with Arbitrum Sepolia testnet ETH (need ~0.01 ETH for deployment gas):
       - Chainlink Faucet: https://faucets.chain.link/arbitrum-sepolia
       - Alchemy Faucet: https://www.alchemy.com/faucets/arbitrum-sepolia
       - QuickNode Faucet: https://faucet.quicknode.com/arbitrum/sepolia
       - L2 Faucet: https://www.l2faucet.com/arbitrum

    4. **Verify your wallet has ETH** on Arbitrum Sepolia:
       ```bash
       cast balance <YOUR_DEPLOYER_ADDRESS> --rpc-url https://sepolia-rollup.arbitrum.io/rpc
       ```

    When ready, type "wallet funded and env file ready" to proceed.
  </how-to-verify>
  <resume-signal>Type "wallet funded and env file ready" when your `.env.arbitrum-sepolia` has real values and your wallet has testnet ETH</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Dry-run deployment on Arbitrum Sepolia fork</name>
  <files>deployments/421614.json</files>
  <action>
    Execute a dry-run deployment to validate everything works before broadcasting real transactions.

    1. Source the environment file:
       ```bash
       source .env.arbitrum-sepolia
       ```

    2. Run the deployment script in dry-run mode (no `--broadcast`):
       ```bash
       forge script script/Deploy.s.sol \
         --rpc-url $ARBITRUM_SEPOLIA_RPC_URL \
         -vvv
       ```

    3. Verify the dry-run output shows:
       - "Network: arbitrum-sepolia" in the pre-deployment summary
       - "Chain ID: 421614"
       - All 5 contracts deployed (FlashloanExecutor, CircuitBreaker, ProfitValidator, UniswapV2Adapter, UniswapV3Adapter)
       - "All configuration checks passed" in Step 5
       - No revert errors

    4. If dry-run succeeds, execute the real deployment with `--broadcast`:
       ```bash
       source .env.arbitrum-sepolia && forge script script/Deploy.s.sol \
         --rpc-url $ARBITRUM_SEPOLIA_RPC_URL \
         --broadcast \
         -vvv
       ```

    5. If `ARBISCAN_API_KEY` is set, also add `--verify --etherscan-api-key $ARBISCAN_API_KEY` to the broadcast command for contract verification.

    6. After deployment, verify `deployments/421614.json` was created by Deploy.s.sol's `exportDeploymentAddresses()` function.

    **Error handling:**
    - If dry-run fails with "BALANCER_VAULT not set": Plan 02-03 didn't run yet. Check that `.env.arbitrum-sepolia` has `BALANCER_VAULT=0xBA12222222228d8Ba445958a75a0704d566BF2C8`.
    - If broadcast fails with "insufficient funds": User needs more testnet ETH from faucet.
    - If broadcast fails with "nonce too low": Wait 30 seconds and retry (sequencer may be processing prior txns).
  </action>
  <verify>
    1. `deployments/421614.json` exists and contains valid JSON
    2. `cat deployments/421614.json | jq .contracts.FlashloanExecutor` returns a non-null address
    3. `cat deployments/421614.json | jq .contracts.CircuitBreaker` returns a non-null address
    4. `cat deployments/421614.json | jq .contracts.ProfitValidator` returns a non-null address
    5. `cat deployments/421614.json | jq .contracts.UniswapV2Adapter` returns a non-null address
    6. `cat deployments/421614.json | jq .contracts.UniswapV3Adapter` returns a non-null address
    7. `cat deployments/421614.json | jq .chainId` returns 421614
    8. `forge test` still passes (no regressions)
  </verify>
  <done>
    All 5 contracts (FlashloanExecutor, CircuitBreaker, ProfitValidator, UniswapV2Adapter, UniswapV3Adapter) are deployed to Arbitrum Sepolia. `deployments/421614.json` contains all contract addresses and configuration. Broadcast logs exist in `broadcast/Deploy.s.sol/421614/`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify deployment on Arbiscan</name>
  <what-built>
    All 5 contracts deployed to Arbitrum Sepolia:
    - FlashloanExecutor (core contract)
    - CircuitBreaker (safety: gas/trade limits)
    - ProfitValidator (safety: profit verification)
    - UniswapV2Adapter (DEX adapter for SushiSwap V2)
    - UniswapV3Adapter (DEX adapter for Uniswap V3)

    Deployment artifact saved to `deployments/421614.json`.
  </what-built>
  <how-to-verify>
    1. Open the deployed contract addresses from `deployments/421614.json`
    2. Check each on Arbiscan Sepolia (https://sepolia.arbiscan.io/):
       - FlashloanExecutor: Verify it shows as a contract (not EOA)
       - CircuitBreaker: Verify it shows as a contract
       - ProfitValidator: Verify it shows as a contract
       - UniswapV2Adapter: Verify it shows as a contract
       - UniswapV3Adapter: Verify it shows as a contract
    3. Optionally verify source code on Arbiscan (if `--verify` was used during deployment)
    4. Check FlashloanExecutor's read functions on Arbiscan:
       - `owner()` should return your deployer address
       - `botWallet()` should return your bot wallet address
       - `paused()` should return false

    Type "deployment verified" or describe any issues.
  </how-to-verify>
  <resume-signal>Type "deployment verified" or describe issues found on Arbiscan</resume-signal>
</task>

</tasks>

<verification>
1. `deployments/421614.json` exists with all 5 contract addresses
2. All contract addresses are non-zero and different from each other
3. `forge test` passes (no regressions from deployment)
4. Contracts visible on Arbiscan Sepolia explorer
</verification>

<success_criteria>
- `deployments/421614.json` contains valid deployment record with chainId 421614
- All 5 contracts have valid addresses (FlashloanExecutor, CircuitBreaker, ProfitValidator, UniswapV2Adapter, UniswapV3Adapter)
- Deployment is confirmed on Arbiscan Sepolia block explorer
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-setup/02-04-SUMMARY.md`
</output>
