---
phase: 05-cross-fee-tier-routing
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - bot/__tests__/detector/cross-fee-tier.test.ts
  - bot/src/run-arb-mainnet.ts
autonomous: true
requirements:
  - ROUTE-02
  - ROUTE-01

must_haves:
  truths:
    - "When two pools for the same pair have different fee tiers and different prices, the detector routes the buy leg through the lower-price pool and the sell leg through the higher-price pool, regardless of fee tier"
    - "Cross-fee-tier pairs produce a lower cost floor than same-tier pairs because the buy-side fee is minimized"
    - "Dry-run output shows the fee tier in each swap step label so operators can verify cross-tier routing"
  artifacts:
    - path: "bot/__tests__/detector/cross-fee-tier.test.ts"
      provides: "Tests verifying cross-fee-tier routing produces lower cost floors"
      min_lines: 60
    - path: "bot/src/run-arb-mainnet.ts"
      provides: "Dry-run entry point with cross-tier visibility in logs"
      contains: "feeTier"
  key_links:
    - from: "bot/__tests__/detector/cross-fee-tier.test.ts"
      to: "bot/src/detector/OpportunityDetector.ts"
      via: "import OpportunityDetector"
      pattern: "OpportunityDetector"
    - from: "bot/src/detector/OpportunityDetector.ts"
      to: "bot/src/monitor/PriceMonitor.ts"
      via: "PriceMonitor.detectOpportunities groups by pairKey"
      pattern: "pairKey"
---

<objective>
Verify and test that cross-fee-tier routing produces lower cost floors than same-tier pairing, and enhance dry-run output to show fee tier information for operator visibility.

Purpose: The bot's PriceMonitor already groups pools by token pair and compares across fee tiers. The OpportunityDetector already applies per-step fee rates from feeTier. This plan validates that the cross-tier cost advantage is real and visible — proving that a buy on UniV3 0.05% + sell on UniV3 0.3% produces a ~0.35% cost floor vs the 0.60% floor of two same-tier pools.

Output: Test file proving cross-tier cost advantage, enhanced dry-run logs showing fee tiers per step.
</objective>

<execution_context>
@/Users/naynay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naynay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@bot/src/detector/OpportunityDetector.ts
@bot/src/detector/types.ts
@bot/src/monitor/PriceMonitor.ts
@bot/src/monitor/types.ts
@bot/__tests__/detector/OpportunityDetector.test.ts
@bot/src/run-arb-mainnet.ts

# Prior plan context (pool config changes)
@.planning/phases/05-cross-fee-tier-routing/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-fee-tier routing tests</name>
  <files>bot/__tests__/detector/cross-fee-tier.test.ts</files>
  <action>
Create `bot/__tests__/detector/cross-fee-tier.test.ts` with tests proving cross-fee-tier routing produces lower cost floors.

**Import the same helpers from the existing OpportunityDetector.test.ts pattern:**
```typescript
import { describe, it, expect } from "vitest";
import { OpportunityDetector } from "../../src/detector/OpportunityDetector.js";
import type { PriceDelta, PriceSnapshot, PoolConfig } from "../../src/monitor/types.js";
```

**Helper factories** (follow the existing pattern from OpportunityDetector.test.ts):
- `makePool(overrides)` — creates a PoolConfig
- `makeSnapshot(pool, price)` — creates a PriceSnapshot
- `makeDelta(buyPool, sellPool, buyPrice, sellPrice)` — creates a PriceDelta

**Test cases:**

1. **"cross-fee-tier pair (0.05% buy + 0.3% sell) has lower cost floor than same-tier pair (0.3% + 0.3%)"**

   Create two scenarios with identical prices and spread:
   - **Same-tier:** buy on Pool A (feeTier: 3000), sell on Pool B (feeTier: 3000)
   - **Cross-tier:** buy on Pool C (feeTier: 500), sell on Pool D (feeTier: 3000)

   Both have the same token pair (e.g., WETH/USDC) and the same price spread (e.g., buy at 3000, sell at 3030 = 1% spread).

   Call `detector.analyzeDelta(sameTierDelta)` and `detector.analyzeDelta(crossTierDelta)` with the same input amount.

   Assert: `crossTierProfit.netProfit > sameTierProfit.netProfit` — the cross-tier path is more profitable because the buy leg only pays 0.05% fee instead of 0.3%.

2. **"cross-fee-tier cost floor is approximately 0.35% (0.05% + 0.3%)"**

   Use a cross-tier delta: buy on feeTier 500, sell on feeTier 3000.
   Set prices so the spread is exactly 1.0% (e.g., buy price 3000, sell price 3030).
   Use `detector.calculateGrossProfit(path, inputAmount)` to get gross profit.

   The gross profit after fee deduction should be approximately `inputAmount * (1 - 0.0005) * spreadFactor * (1 - 0.003) - inputAmount`. The combined fee deduction of ~0.35% should leave ~0.65% of the 1% spread as gross profit.

   Assert: grossProfit is between 0.60% and 0.70% of inputAmount (the remaining ~0.35% was consumed by trading fees). This proves the 0.35% cost floor.

3. **"same-tier cost floor is approximately 0.60% (0.3% + 0.3%)"**

   Same setup but both pools at feeTier 3000.
   With a 1% spread, grossProfit should be ~0.40% of inputAmount (0.60% consumed by fees).

   Assert: grossProfit is between 0.35% and 0.45% of inputAmount.

4. **"PriceMonitor pairKey groups cross-fee-tier pools together"**

   Create two pools with the same token pair but different fee tiers. Verify that PriceMonitor's `pairKey` method produces the same key for both. Since `pairKey` is private, test this indirectly: import ARBITRUM_MAINNET_POOLS and verify that WETH/USDC 0.05% and WETH/USDC 0.3% pools produce the same canonical pair key using a local `pairKey` function with the same logic (`[token0, token1].sort().join("/")`).

5. **"buildSwapPath includes feeTier on each step"**

   Create a cross-tier delta (buy pool feeTier: 500, sell pool feeTier: 3000).
   Call `detector.buildSwapPath(delta)`.
   Assert: `path.steps[0].feeTier === 500` and `path.steps[1].feeTier === 3000`.

6. **"getSwapFeeRate returns correct rates for different fee tiers"**

   Test via `calculateGrossProfit`: create two identical paths except for feeTier.
   Path A: both steps feeTier 3000 (0.3%).
   Path B: step 1 feeTier 500 (0.05%), step 2 feeTier 3000 (0.3%).
   Assert: Path B grossProfit > Path A grossProfit.

**Detector configuration for tests:**
```typescript
const detector = new OpportunityDetector({
  minProfitThreshold: 0,  // Accept all for testing
  maxSlippage: 0,          // No slippage for clean fee math
  defaultInputAmount: 10,
  gasPriceGwei: 0,         // Zero gas for clean fee isolation
  gasPerSwap: 0,
  flashLoanFees: { aaveV3: 0, dydx: 0, balancer: 0 }, // Zero flash fees for clean fee isolation
});
```

This isolates DEX trading fees as the only cost, making the cost floor calculation clean and verifiable.
  </action>
  <verify>
`pnpm test -- --run bot/__tests__/detector/cross-fee-tier.test.ts` — all 6 tests pass.
  </verify>
  <done>
6 tests pass proving: (a) cross-tier pairs produce higher net profit than same-tier pairs, (b) cross-tier cost floor is ~0.35% vs same-tier ~0.60%, (c) fee tiers are preserved in swap paths, (d) pairKey groups cross-tier pools together.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fee-tier visibility to dry-run output</name>
  <files>bot/src/run-arb-mainnet.ts</files>
  <action>
Enhance the `opportunityFound` event handler in `run-arb-mainnet.ts` to show fee tier information for each swap step, making cross-tier routing visible to operators.

**Current output format (lines 149-164):**
```
[OPPORTUNITY] ================================
  Path:       WETH/USDC UniV3 (0.05%) → WETH/USDC UniV3 (0.3%)
  Input:      5 ETH
  ...
```

The path label already includes fee tier info from the pool labels. But the individual step fee rates are not shown.

**Add after the "Path:" line, before "Input:":**
```typescript
// Show individual step fee breakdown for cross-tier visibility
for (let i = 0; i < opp.path.steps.length; i++) {
  const step = opp.path.steps[i];
  const feeRate = step.feeTier !== undefined
    ? `${(step.feeTier / 10000).toFixed(2)}%`
    : "0.30% (V2)";
  const direction = i === 0 ? "Buy" : "Sell";
  console.log(col(`  ${direction} fee:   ${feeRate} on ${step.dex}`));
}
const combinedFee = opp.path.steps.reduce((sum, s) => {
  const rate = s.feeTier !== undefined ? s.feeTier / 1_000_000 : 0.003;
  return sum + rate;
}, 0);
console.log(col(`  Cost floor: ~${(combinedFee * 100).toFixed(2)}% (trading fees only)`));
```

This adds 3-4 lines to each opportunity report:
```
  Buy fee:   0.05% on uniswap_v3
  Sell fee:  0.30% on uniswap_v3
  Cost floor: ~0.35% (trading fees only)
```

**Important:** Insert these lines between the existing `Path:` and `Input:` log lines. Do NOT change or remove any existing log lines — only add new ones.
  </action>
  <verify>
1. `pnpm exec tsc --noEmit` passes (no type errors)
2. Visual inspection: the new lines are between "Path:" and "Input:" in the event handler
3. `pnpm test` — all existing tests pass (run-arb-mainnet.ts is not tested directly, but type-checking confirms no breakage)
  </verify>
  <done>
Dry-run output shows per-step fee rates (Buy fee / Sell fee) and a combined cost floor percentage for each detected opportunity. Operators can see at a glance whether an opportunity uses cross-tier routing (e.g., "Cost floor: ~0.35%") vs same-tier routing ("Cost floor: ~0.60%").
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` — no type errors across the project
2. `pnpm test -- --run bot/__tests__/detector/cross-fee-tier.test.ts` — 6 cross-tier tests pass
3. `pnpm test` — all existing tests pass (full suite: 423+ TypeScript tests)
4. `forge test` — all Solidity tests pass (312 tests, unchanged)
5. Dry-run output format shows fee tier per step and combined cost floor
</verification>

<success_criteria>
Cross-fee-tier routing is proven via tests to produce ~0.35% cost floor (vs 0.60% same-tier). Dry-run output shows fee tier breakdown per opportunity. All tests pass with no regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-fee-tier-routing/05-02-SUMMARY.md`
</output>
