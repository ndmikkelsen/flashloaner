---
phase: 12-contract-deployment-live-validation
plan: 03
type: execute
wave: 3
depends_on: [12-02]
files_modified: []
autonomous: false
requirements: [EXEC-01]

must_haves:
  truths:
    - "Bot runs in live mode and submits real transactions to Arbitrum mainnet"
    - "Bot executes at least one arbitrage transaction confirmed on-chain (profitable or reverted — confirms the pipeline is live)"
    - "At least one trade is net-profitable (grossProfit exceeds gasCost plus l1DataFee)"
    - "Trade outcomes are persisted to .data/trades.jsonl with three-bucket P&L"
    - "Bot operates with all safety guards active: staleness guard (200ms), circuit breaker (5 failures), profit validator (on-chain)"
  artifacts:
    - path: ".data/trades.jsonl"
      provides: "Persisted trade outcomes with three-bucket P&L"
      contains: "txHash"
  key_links:
    - from: "bot/src/index.ts (live mode)"
      to: "FlashloanExecutor (on-chain)"
      via: "ExecutionEngine.executeTransaction() with signed transaction"
    - from: "FlashloanExecutor"
      to: "ProfitValidator"
      via: "On-chain call — reverts entire flash loan if profit < minProfit"
    - from: "ExecutionEngine"
      to: ".data/trades.jsonl"
      via: "TradeStore.append() after confirmation or revert"
---

<objective>
Switch the bot from shadow mode to live mode and execute real arbitrage trades on Arbitrum mainnet, achieving at least one profitable trade to complete the v1.1 milestone.

Purpose: Prove the end-to-end system works with real capital: price monitoring, opportunity detection, optimal sizing, transaction building, flash loan execution, DEX swaps, and profit capture — all on Arbitrum mainnet.
Output: At least one profitable trade on Arbiscan + trade data in .data/trades.jsonl.
</objective>

<execution_context>
@/Users/naynay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naynay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-contract-deployment-live-validation/12-02-SUMMARY.md
@bot/src/run-arb-mainnet.ts
@bot/src/index.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Switch to live mode and start the bot</name>
  <action>
IMPORTANT: Only proceed after shadow mode validation is complete (Plan 12-02 approved).

**1. Verify deployer wallet has ETH for gas:**
```bash
cast balance 0x8d7a596F072e462E7b018747e62EC8eB01191a18 --rpc-url $RPC_URL
```

Each failed arbitrage transaction costs approximately $0.01-0.05 on Arbitrum (L2 execution gas + L1 data fee). Each successful trade earns more than the gas cost (the profit validator enforces this on-chain). Start with at least 0.05 ETH for gas to handle a few failed attempts.

Note: Flash loans (Aave V3 / Balancer) provide the trading capital — you do NOT need to fund the wallet with 1000 ETH for trades, only gas for the transactions.

**2. Switch the mode environment variables:**
```bash
# Switch from shadow to live
export DRY_RUN="false"
export SHADOW_MODE="false"    # <-- This is the only change from Plan 12-02

# All other env vars remain the same:
# RPC_URL, BOT_PRIVATE_KEY, EXECUTOR_ADDRESS, ADAPTER_* addresses
```

**3. Start the bot in live mode:**
```bash
cd /Users/naynay/Projects/personal/feat.web-sockets/bot
node --import tsx src/run-arb-mainnet.ts
```

**Expected startup output:**
```
========================================
  Flashloan Bot v1.1.0 — ARBITRUM ONE
  Mode:     LIVE
  Chain:    Arbitrum One (chainId 42161)
  RPC:      configured
  Wallet:   0x8d7a596F072e462E7b018747e62EC8eB01191a18
  Balance:  X.XXXXXX ETH
========================================
```

**For unattended operation via pm2:**
```bash
# Edit ecosystem.config.cjs: set SHADOW_MODE to "false" (DRY_RUN is already "false")
pm2 start ecosystem.config.cjs
pm2 logs flashloan-bot --lines 100
```

**What happens in live mode when an opportunity is detected:**
1. Staleness guard: aborts if price data is > 200ms old
2. Per-pair cooldown: skips if same pair submitted within last 10 seconds
3. Revert cooldown: skips if same pair reverted recently
4. TransactionBuilder encodes the arbitrage calldata
5. ArbitrumGasEstimator calculates L2 execution + L1 data fee
6. Zero-address adapter guard (from Task 1 in Plan 12-01): skips if any step uses undeployed adapter
7. NonceManager acquires the next nonce (crash-safe)
8. Transaction signed and submitted to Arbitrum sequencer
9. On-chain: FlashloanExecutor borrows via flash loan, executes swap steps through adapters, repays loan
10. On-chain: ProfitValidator enforces profit > minProfit (0.01 ETH), reverts entire trade atomically if not met
11. ExecutionEngine waits for confirmation, parses ArbitrageExecuted event
12. TradeStore persists outcome to .data/trades.jsonl with three-bucket P&L

**Capital risk is strictly bounded:**
- Flash loans: zero capital risk (borrow-and-repay is atomic — only fails if unprofitable)
- The ONLY capital at risk is gas for failed/reverted transactions (~$0.01-0.05 each on Arbitrum)
  </action>
  <verify>
Bot starts showing "Mode: LIVE" in the startup banner (not SHADOW or DRY-RUN). No startup errors. First price update log appears within 30 seconds. CircuitBreaker is not paused: `cast call $EXECUTOR_ADDRESS "paused()" --rpc-url $RPC_URL` returns false.
  </verify>
  <done>Bot running in live mode on Arbitrum mainnet. Mode banner confirms LIVE. Contract not paused. Price monitoring active. Ready to submit real transactions.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Monitor live trades and validate first profitable execution</name>
  <action>
Monitor the bot for trade execution. The time to first trade depends on market conditions — it may take minutes or hours.

**Watch for trade activity:**
```bash
# If using pm2:
pm2 logs flashloan-bot --lines 200 --follow

# Key log lines to watch for:
# "Submitting transaction..."  — tx being broadcast to Arbitrum sequencer
# "Transaction confirmed"      — trade landed and mined
# "Transaction reverted"       — trade failed (expected sometimes — only gas lost)
# "[STALE] Opportunity..."     — price data too old, correctly skipped (200ms guard)
# "[COOLDOWN] Skipping..."     — pair in cooldown, correctly skipped
```

**Check persisted trade history:**
```bash
# View all trades (JSONL format — one JSON object per line)
cat /Users/naynay/Projects/personal/feat.web-sockets/.data/trades.jsonl

# Count total trades
cat /Users/naynay/Projects/personal/feat.web-sockets/.data/trades.jsonl | wc -l

# View last 5 trades (pretty-printed)
tail -5 /Users/naynay/Projects/personal/feat.web-sockets/.data/trades.jsonl | while read line; do echo $line | python3 -m json.tool; done
```

**When you see a "Transaction confirmed" log with a txHash, verify on Arbiscan:**
```
https://arbiscan.io/tx/<txHash>
```
The transaction should show:
- Green checkmark (success)
- Token transfers: flash loan borrow → swap A → swap B → repay → profit retained
- ArbitrageExecuted event in the Logs tab

**Interpreting trade outcomes in .data/trades.jsonl:**
```json
{
  "txHash": "0x...",
  "status": "success",       // "success" | "revert" | "simulation_revert"
  "grossProfit": 0.012,      // Raw profit from ArbitrageExecuted event (ETH)
  "gasCost": 0.0003,         // L2 execution gas cost (ETH)
  "l1DataFee": 0.00005,      // Arbitrum L1 data fee component (ETH)
  "revertCost": 0,           // Gas burned on failed tx (ETH)
  "netProfit": 0.0117        // grossProfit - gasCost - l1DataFee - revertCost (ETH)
}
```
A trade is profitable when `netProfit > 0` (equivalently, `grossProfit > gasCost + l1DataFee`).

**Troubleshooting if no opportunities execute after several hours:**
- Check if shadow mode was finding opportunities — if shadow found them, live should execute them
- Check gas price: `cast gas-price --rpc-url $RPC_URL`. If base fee spiked, estimated gas cost may exceed profit
- Check MIN_PROFIT_WEI: currently 0.01 ETH. Current market spreads may be thinner. Consider lowering to 0.005 ETH if needed: `export MIN_PROFIT_WEI="5000000000000000"`
- Check circuit breaker state: `cast call $EXECUTOR_ADDRESS "paused()" --rpc-url $RPC_URL`. If true (5 consecutive failures tripped it), call `unpause()` from the owner wallet: `cast send $EXECUTOR_ADDRESS "unpause()" --private-key $DEPLOYER_PRIVATE_KEY --rpc-url $RPC_URL`

**If all transactions are reverting with the same reason:**
- `InsufficientProfit(received, required)` → market moved between detection and execution; normal at low volumes
- `ContractPaused()` → circuit breaker tripped; call unpause() as above
- `NotAuthorized()` → BOT_PRIVATE_KEY does not match the botWallet registered at deployment; re-deploy with matching keys
  </action>
  <verify>
At least one transaction confirmed on Arbitrum mainnet (visible in Arbiscan with a real txHash). At least one trade has `netProfit > 0` in .data/trades.jsonl (grossProfit > gasCost + l1DataFee). Type "live validated" with trade results: total trade count, success count, at least one txHash, and net P&L. Or describe any issues encountered.
  </verify>
  <done>Bot executed at least one profitable live trade on Arbitrum mainnet. Trade outcome (txHash, three-bucket P&L) persisted to .data/trades.jsonl. NetProfit is positive. Phase 12 complete.</done>
</task>

</tasks>

<verification>
1. Bot operated in LIVE mode on Arbitrum mainnet (startup banner confirmed)
2. At least one real transaction submitted and confirmed on-chain (txHash on Arbiscan)
3. At least one trade net-profitable: `grossProfit > gasCost + l1DataFee` (visible in .data/trades.jsonl)
4. Three-bucket P&L recorded correctly in .data/trades.jsonl (grossProfit, gasCost, l1DataFee, revertCost, netProfit)
5. All safety guards were active during operation: staleness guard (200ms), circuit breaker (5-failure threshold), ProfitValidator (on-chain minimum)
</verification>

<success_criteria>
Phase 12 is complete when the bot has executed at least one profitable live arbitrage trade on Arbitrum mainnet. This validates the complete v1.1 pipeline end-to-end: price monitoring, opportunity detection with ternary search optimization, cross-fee-tier routing, transaction building, flash loan execution via Aave V3 or Balancer, DEX swaps through registered adapters, and profit capture — all on Arbitrum mainnet with real capital.
</success_criteria>

<output>
After completion, create `/Users/naynay/Projects/personal/feat.web-sockets/.planning/phases/12-contract-deployment-live-validation/12-03-SUMMARY.md`
</output>
