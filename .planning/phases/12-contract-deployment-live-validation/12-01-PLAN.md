---
phase: 12-contract-deployment-live-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/src/builder/TransactionBuilder.ts
  - bot/src/run-arb-mainnet.ts
  - deployments/42161.json
  - broadcast/Deploy.s.sol/42161/run-latest.json
autonomous: false
requirements: [EXEC-01, EXEC-02]

must_haves:
  truths:
    - "Bot refuses to enter shadow/live mode when EXECUTOR_ADDRESS is zero address"
    - "Opportunities using adapters with zero address are silently skipped before transaction building"
    - "FlashloanExecutor is deployed to Arbitrum mainnet and verified on Arbiscan"
    - "UniswapV3Adapter, SushiSwapV2Adapter, and TraderJoeLBAdapter are registered with the executor"
    - "Bot wallet (deployer) is authorized to call executeArbitrage on the executor"
    - "Deployed addresses are recorded in deployments/42161.json"
  artifacts:
    - path: "bot/src/builder/TransactionBuilder.ts"
      provides: "Zero-address adapter guard in resolveAdapter()"
      contains: "zero address"
    - path: "bot/src/run-arb-mainnet.ts"
      provides: "EXECUTOR_ADDRESS validation guard at startup"
      contains: "EXECUTOR_ADDRESS"
    - path: "deployments/42161.json"
      provides: "All deployed contract addresses on Arbitrum mainnet"
      contains: "FlashloanExecutor"
    - path: "broadcast/Deploy.s.sol/42161/run-latest.json"
      provides: "Foundry broadcast receipt with transaction hashes"
  key_links:
    - from: "bot/src/index.ts (shadow/live mode)"
      to: "TransactionBuilder.resolveAdapter()"
      via: "opportunityFound handler calls builder.buildArbitrageTransaction()"
      pattern: "resolveAdapter"
    - from: "bot/src/run-arb-mainnet.ts"
      to: "FlashloanExecutor (on-chain)"
      via: "EXECUTOR_ADDRESS env var validated at startup"
      pattern: "EXECUTOR_ADDRESS"
    - from: "FlashloanExecutor"
      to: "All adapters"
      via: "registerAdapter() calls in Deploy.s.sol"
---

<objective>
Patch two critical bot-level safety gaps before deployment, then deploy FlashloanExecutor and all DEX adapters to Arbitrum mainnet using the existing Deploy.s.sol script.

Purpose: Prevent silent failures in shadow/live mode (zero-address EXECUTOR_ADDRESS sending tx to wrong contract; Camelot opportunities causing AdapterNotApproved revert) and get on-chain infrastructure live.
Output: Patched bot code + verified contracts on Arbitrum mainnet + deployments/42161.json with all addresses.
</objective>

<execution_context>
@/Users/naynay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naynay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/src/builder/TransactionBuilder.ts
@bot/src/run-arb-mainnet.ts
@contracts/script/Deploy.s.sol
@bot/src/config/chains/arbitrum.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Patch zero-address adapter guard and EXECUTOR_ADDRESS validation</name>
  <files>bot/src/builder/TransactionBuilder.ts, bot/src/run-arb-mainnet.ts</files>
  <action>
Two patches needed. Read both files fully before editing.

**Patch 1 — TransactionBuilder.ts, resolveAdapter() method (lines ~180-186):**

The current implementation throws if no adapter is configured for a DEX. The gap: Camelot pools are monitored but no CamelotV2Adapter exists — `adapters.camelot_v2` will be `"0x0000000000000000000000000000000000000000"` (the zero-address default). When `buildArbitrageTransaction` calls `encodeSwapSteps`, `resolveAdapter("camelot_v2")` returns zero address without error, producing a transaction that reverts on-chain with `AdapterNotApproved(address(0))`.

Change `resolveAdapter()` to return `null` when the resolved address is the zero address (instead of throwing or returning it), then update `buildArbitrageTransaction` to throw a filterable error when any step has a zero-address adapter:

```typescript
private static readonly ZERO_ADDRESS = "0x0000000000000000000000000000000000000000";

resolveAdapter(dex: DEXProtocol): string {
  const adapter = this.config.adapters[dex];
  if (!adapter) {
    throw new Error(`No adapter configured for DEX protocol: ${dex}`);
  }
  if (adapter === TransactionBuilder.ZERO_ADDRESS) {
    throw new Error(`Adapter for DEX protocol '${dex}' is zero address — adapter not deployed`);
  }
  return adapter;
}
```

This causes `buildArbitrageTransaction` to throw when any swap step uses an undeployed adapter. In `bot/src/index.ts`, the `opportunityFound` handler already wraps execution in try/catch and logs errors — the throw will be caught and the opportunity skipped. Add a log note in the catch so it's visible:

In `index.ts`, find the `opportunityFound` handler's try/catch block for SHADOW and LIVE modes. The error thrown by `buildArbitrageTransaction` will surface as a logged error. This is correct behavior — no additional change needed in index.ts.

**Patch 2 — run-arb-mainnet.ts, EXECUTOR_ADDRESS validation (around line 180):**

After the existing wallet balance check and before the `executionConfig` object is constructed (around line 177-194), add a guard that exits if EXECUTOR_ADDRESS is unset or is the zero address when entering shadow/live mode:

```typescript
// Guard: EXECUTOR_ADDRESS must be set for shadow/live mode
if (shadowMode || liveMode) {
  const executorAddr = process.env.EXECUTOR_ADDRESS;
  const ZERO = "0x0000000000000000000000000000000000000000";
  if (!executorAddr || executorAddr === ZERO) {
    console.error(`[ERROR] EXECUTOR_ADDRESS is not set or is the zero address.`);
    console.error(`[ERROR] Set EXECUTOR_ADDRESS to the deployed FlashloanExecutor address from deployments/42161.json`);
    console.error(`[ERROR] Cannot enter ${mode} mode without a valid executor contract.`);
    process.exit(1);
  }
}
```

Insert this block immediately after the wallet balance check (after line ~174) and before the `executionConfig` object literal (line ~178).

After both patches, run the TypeScript compiler to verify no type errors:
```bash
cd /Users/naynay/Projects/personal/feat.web-sockets/bot && npx tsc --noEmit
```

Also run the test suite to confirm existing tests still pass:
```bash
cd /Users/naynay/Projects/personal/feat.web-sockets/bot && pnpm test
```
  </action>
  <verify>
1. `cd /Users/naynay/Projects/personal/feat.web-sockets/bot && npx tsc --noEmit` exits 0 with no errors.
2. `pnpm test` passes all existing tests.
3. `grep -n "zero address" bot/src/builder/TransactionBuilder.ts` shows the new guard comment.
4. `grep -n "EXECUTOR_ADDRESS" bot/src/run-arb-mainnet.ts` shows the new validation block.
  </verify>
  <done>TransactionBuilder.resolveAdapter() throws on zero-address adapters. run-arb-mainnet.ts exits with a clear error if EXECUTOR_ADDRESS is unset or zero in shadow/live mode. All TypeScript compiles cleanly. All existing tests pass.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Fund deployer wallet and verify environment</name>
  <action>
All env vars are managed via `.envrc` + 1Password (`flashloaner-bot` item, `.env.arbitrum-mainnet` attachment). Run `direnv reload` in the project root — direnv reads the file from 1Password and exports all vars automatically.

**1. Reload env and verify vars are set:**
```bash
cd /path/to/flashloaner && direnv reload
echo $DEPLOYER_PRIVATE_KEY | wc -c   # → 67 (0x + 64 hex + newline)
echo $BOT_WALLET_ADDRESS             # → 0x8d7a596F072e462E7b018747e62EC8eB01191a18
echo $ARBISCAN_API_KEY               # → non-empty
echo $AAVE_V3_POOL                   # → 0x794a61358D6845594F94dc1DB02A252b5b4814aD
```

**2. Check deployer wallet balance on Arbitrum (need ≥ 0.01 ETH):**
```bash
cast balance $BOT_WALLET_ADDRESS --rpc-url $RPC_URL
```
Fund from an exchange or transfer if needed. Arbitrum gas is cheap — 0.02 ETH is ample for a full deployment.

**Notes:**
- `DEPLOYER_PRIVATE_KEY` must control `BOT_WALLET_ADDRESS` (verified via `flashloaner-bot` 1Password item — Wallet Deployer address matches).
- `UNISWAP_V2_ROUTER` is intentionally absent — Uniswap V2 was never deployed on Arbitrum.
- `SUSHISWAP_V3_ROUTER` / `SUSHISWAP_V3_QUOTER` may be empty — Sushi V3 router on Arbitrum is unconfirmed; deploy script skips it gracefully.
- `EXECUTOR_ADDRESS` and `ADAPTER_*` will be empty until after Task 3 deployment. Update the 1Password `.env.arbitrum-mainnet` file with deployed addresses, then `direnv reload`.
  </action>
  <verify>
`echo $DEPLOYER_PRIVATE_KEY | wc -c` outputs 67. `cast balance $BOT_WALLET_ADDRESS --rpc-url $RPC_URL` shows > 0.01 ETH. `echo $ARBISCAN_API_KEY` is non-empty.
  </verify>
  <done>Direnv loaded all vars from 1Password. Deployer wallet has sufficient ETH on Arbitrum. Ready for forge deployment in Task 3.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Dry-run then broadcast deployment to Arbitrum mainnet</name>
  <action>
First simulate the deployment (no broadcast), verify the output, then broadcast to mainnet.

**Step A — Dry-run (simulation, no transactions sent):**
```bash
cd /Users/naynay/Projects/personal/feat.web-sockets

forge script contracts/script/Deploy.s.sol:Deploy \
  --rpc-url $ARBITRUM_RPC_URL \
  -vvv
```

Expected output:
- Chain ID 42161 (Arbitrum One)
- CircuitBreaker and ProfitValidator deployed (simulation)
- FlashloanExecutor deployed with Aave + Balancer providers
- UniswapV3Adapter deployed
- SushiSwapV2Adapter deployed (reuses UniswapV2Adapter with Sushi router)
- TraderJoeLBAdapter deployed
- UniswapV2Adapter SKIPPED (no Uniswap V2 on Arbitrum)
- All adapters registered via registerAdapter()
- Configuration assertions passed
- "DEPLOYMENT SUCCESSFUL" printed with all addresses

If dry-run fails with "DEPLOYER_PRIVATE_KEY not set" — re-export env vars. If it fails with compilation errors — run `forge build` first.

**Step B — Broadcast to Arbitrum mainnet (only after dry-run succeeds):**
```bash
forge script contracts/script/Deploy.s.sol:Deploy \
  --rpc-url $ARBITRUM_RPC_URL \
  --broadcast \
  --verify \
  --slow \
  --etherscan-api-key $ARBISCAN_API_KEY \
  -vvv
```

The `--slow` flag waits for each transaction to mine before sending the next (safer for mainnet). The `--verify` flag submits source to Arbiscan automatically.

After deployment completes:
- `deployments/42161.json` will contain all deployed addresses
- `broadcast/Deploy.s.sol/42161/run-latest.json` will contain transaction hashes

**Record the FlashloanExecutor address** — you will need it as EXECUTOR_ADDRESS for Plans 12-02 and 12-03.

**If Arbiscan verification fails** (rate limiting is common — Arbiscan limits 1 req/5s):
```bash
# Manually verify FlashloanExecutor
forge verify-contract <EXECUTOR_ADDRESS> \
  contracts/src/FlashloanExecutor.sol:FlashloanExecutor \
  --chain arbitrum \
  --etherscan-api-key $ARBISCAN_API_KEY \
  --constructor-args $(cast abi-encode \
    "constructor(address,address,address,address,uint256)" \
    0x794a61358D6845594F94dc1DB02A252b5b4814aD \
    0xBA12222222228d8Ba445958a75a0704d566BF2C8 \
    0x8d7a596F072e462E7b018747e62EC8eB01191a18 \
    0x8d7a596F072e462E7b018747e62EC8eB01191a18 \
    10000000000000000)
```

Wait 60 seconds between each `forge verify-contract` call to avoid rate limits.

**Verify the deployment on-chain:**
```bash
# Confirm owner is deployer
cast call <EXECUTOR_ADDRESS> "owner()" --rpc-url $ARBITRUM_RPC_URL

# Confirm bot wallet is authorized
cast call <EXECUTOR_ADDRESS> "botWallet()" --rpc-url $ARBITRUM_RPC_URL

# Confirm not paused
cast call <EXECUTOR_ADDRESS> "paused()" --rpc-url $ARBITRUM_RPC_URL
```
  </action>
  <verify>
1. `cat /Users/naynay/Projects/personal/feat.web-sockets/deployments/42161.json` exists and contains non-zero addresses for FlashloanExecutor, UniswapV3Adapter, SushiSwapV2Adapter (as UniswapV2Adapter), and TraderJoeLBAdapter.
2. `cast call <EXECUTOR_ADDRESS> "owner()" --rpc-url $ARBITRUM_RPC_URL` returns the deployer address.
3. `cast call <EXECUTOR_ADDRESS> "paused()" --rpc-url $ARBITRUM_RPC_URL` returns false.
4. Arbiscan shows verified contract at the executor address (or verification is in progress).
  </verify>
  <done>FlashloanExecutor and all DEX adapters deployed to Arbitrum mainnet (chain ID 42161). Verified source on Arbiscan. Addresses saved in deployments/42161.json. Owner and botWallet are correctly set. Contract is not paused.</done>
</task>

</tasks>

<verification>
1. `cd /Users/naynay/Projects/personal/feat.web-sockets/bot && pnpm test` — all tests pass
2. `npx tsc --noEmit` — no TypeScript errors
3. `cat /Users/naynay/Projects/personal/feat.web-sockets/deployments/42161.json` — valid JSON with non-zero contract addresses
4. `cast call <EXECUTOR_ADDRESS> "owner()" --rpc-url $ARBITRUM_RPC_URL` — returns deployer address
5. `cast call <EXECUTOR_ADDRESS> "paused()" --rpc-url $ARBITRUM_RPC_URL` — returns false
6. Arbiscan: https://arbiscan.io/address/<EXECUTOR_ADDRESS> shows verified source
</verification>

<success_criteria>
Bot code patched with two safety guards (zero-address adapter skip, EXECUTOR_ADDRESS validation). FlashloanExecutor and all DEX adapters (UniswapV3, SushiSwapV2, TraderJoeLB) deployed to Arbitrum mainnet, verified on Arbiscan, addresses in deployments/42161.json. Executor is owned by deployer, botWallet set correctly, not paused.
</success_criteria>

<output>
After completion, create `/Users/naynay/Projects/personal/feat.web-sockets/.planning/phases/12-contract-deployment-live-validation/12-01-SUMMARY.md`
</output>
