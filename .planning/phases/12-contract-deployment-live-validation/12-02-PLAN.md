---
phase: 12-contract-deployment-live-validation
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified: []
autonomous: false
requirements: [EXEC-02]

must_haves:
  truths:
    - "Bot runs in shadow mode on Arbitrum mainnet, simulating trades via eth_call without broadcasting"
    - "Shadow mode logs estimated profit for each opportunity alongside simulation pass/fail"
    - "At least 100 opportunities have been detected and simulated"
    - "Simulation pass rate is greater than 50% of profitable opportunities (systematic failure would indicate contract configuration error)"
    - "No systematic simulation failures with the same revert reason across all opportunities"
  artifacts: []
  key_links:
    - from: "bot/src/run-arb-mainnet.ts"
      to: "FlashloanExecutor (deployed)"
      via: "EXECUTOR_ADDRESS env var — validated at startup to be non-zero"
    - from: "bot/src/index.ts (shadow mode)"
      to: "ExecutionEngine.simulateTransaction()"
      via: "opportunityFound handler, returns {success: boolean, reason?: string}"
---

<objective>
Run the bot in shadow mode against Arbitrum mainnet to validate the full pipeline via eth_call simulation before spending real gas.

Purpose: Confirm contracts are correctly wired (adapters registered, executor authorized) and the detection pipeline produces opportunities that simulate successfully on-chain. Shadow mode returns pass/fail only — not decoded profit amounts — so the criterion is simulation pass rate, not exact profit comparison.
Output: Shadow mode logs showing simulation pass rate over 100+ opportunities. Confidence that live mode will execute rather than revert.
</objective>

<execution_context>
@/Users/naynay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naynay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/src/run-arb-mainnet.ts
@bot/src/index.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure and launch bot in shadow mode</name>
  <action>
Set up environment variables with the deployed contract addresses from Plan 12-01 and start the bot in shadow mode.

**1. Set environment variables (add to your terminal session):**
```bash
# RPC endpoint
export RPC_URL="<your Arbitrum One RPC URL — Alchemy, Infura, or other>"

# Execution mode: SHADOW (eth_call simulate, no gas spent)
export DRY_RUN="false"
export SHADOW_MODE="true"

# Wallet for signing eth_call context (must be the bot/deployer wallet)
# BOT_PRIVATE_KEY is checked first, PRIVATE_KEY is the fallback
export BOT_PRIVATE_KEY="<your deployer private key>"

# Deployed contract addresses — copy exact values from deployments/42161.json
export EXECUTOR_ADDRESS="<FlashloanExecutor address>"
export ADAPTER_UNISWAP_V3="<UniswapV3Adapter address>"
export ADAPTER_SUSHISWAP="<SushiSwapV2Adapter address>"
export ADAPTER_TRADERJOE_LB="<TraderJoeLBAdapter address>"

# Adapters NOT deployed — leave unset (default zero address will be caught by guard)
# ADAPTER_UNISWAP_V2 — no Uniswap V2 on Arbitrum
# ADAPTER_CAMELOT_V2 — not built (opportunities will be skipped by zero-address guard)
# ADAPTER_CAMELOT_V3 — not built
# ADAPTER_SUSHISWAP_V3 — not built
# ADAPTER_RAMSES — no active Ramses pools, not wired in Deploy.s.sol
```

**2. Verify the executor address is live before starting:**
```bash
cast call $EXECUTOR_ADDRESS "owner()" --rpc-url $RPC_URL
cast call $EXECUTOR_ADDRESS "paused()" --rpc-url $RPC_URL
```
Both calls must succeed. If they fail, the address is wrong.

**3. Launch the bot in shadow mode:**
```bash
cd /Users/naynay/Projects/personal/feat.web-sockets/bot
node --import tsx src/run-arb-mainnet.ts
```

**Expected startup output:**
```
========================================
  Flashloan Bot v1.1.0 — ARBITRUM ONE
  Mode:     SHADOW
  Chain:    Arbitrum One (chainId 42161)
  RPC:      configured
  Wallet:   0x8d7a596F072e462E7b018747e62EC8eB01191a18
  Balance:  X.XXXXXX ETH
========================================
```

If instead the bot exits immediately with "[ERROR] EXECUTOR_ADDRESS is not set or is the zero address" — set EXECUTOR_ADDRESS from deployments/42161.json.

**For unattended operation via pm2:**
```bash
# Update ecosystem.config.cjs to set the env vars, then:
pm2 start ecosystem.config.cjs
pm2 logs flashloan-bot --lines 100
```

**What shadow mode does:**
- Monitors all configured Arbitrum pools for price deltas
- When an opportunity is detected, builds the transaction calldata via TransactionBuilder
- If any swap step uses an undeployed adapter (camelot_v2, etc.), the opportunity is skipped with a logged error
- For valid opportunities, simulates via `eth_call` (free, no gas cost)
- Logs: `[SHADOW] ✓ Simulation succeeded` with estimated profit, OR `[SHADOW] ✗ Simulation failed` with revert reason
- Does NOT broadcast any transactions
  </action>
  <verify>
Bot starts showing "Mode: SHADOW" in the startup banner. No startup errors (missing env vars, EXECUTOR_ADDRESS zero-address guard). First price update log appears within 30 seconds. When the first opportunity is detected, a [SHADOW] log line appears showing either simulation success or a specific revert reason.
  </verify>
  <done>Bot running in shadow mode on Arbitrum mainnet. Monitoring all configured pools. Each detected opportunity is being simulated via eth_call and the result logged.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Validate shadow mode results over 100+ opportunities</name>
  <action>
Let the bot run until at least 100 opportunities have been detected. This typically takes 4-8 hours depending on market activity. Review the results to confirm the pipeline is healthy before enabling live mode.

**Monitor logs while running:**
```bash
# If using pm2:
pm2 logs flashloan-bot --lines 200

# If running in terminal: watch the stdout directly.
```

**Key log patterns to watch for:**

Success (green):
```
[SHADOW] ✓ Simulation succeeded for <id>
[SHADOW]   Estimated profit: 0.00123456 ETH
[SHADOW]   Would broadcast in live mode
```

Failure (yellow):
```
[SHADOW] ✗ Simulation failed: <revert reason>
[SHADOW]   Estimated profit was 0.00123456 ETH, but would revert on-chain
```

Skipped by zero-address guard (logged as error in index.ts catch block):
```
[ERROR] Adapter for DEX protocol 'camelot_v2' is zero address — adapter not deployed
```
This is expected and correct behavior — Camelot opportunities are safely skipped.

**After 100+ opportunities, count results:**
```bash
# Count simulation successes
grep -c "\[SHADOW\] ✓" <log-file-path>

# Count simulation failures
grep -c "\[SHADOW\] ✗" <log-file-path>

# View the last 20 simulation results
grep "\[SHADOW\]" <log-file-path> | tail -40
```

**Interpretation guide:**

| Pass Rate | Meaning | Action |
|-----------|---------|--------|
| > 50% | HEALTHY — most opportunities are executable | Proceed to live mode (Plan 12-03) |
| 20-50% | MARGINAL — high market competition or slippage | Acceptable — proceed with caution |
| < 20% | SYSTEMATIC FAILURE — something is wrong | Diagnose before proceeding |

**If pass rate < 20%, diagnose by checking the most common revert reasons:**
- `AdapterNotApproved(address)` with a non-zero address → adapter not registered with executor. Run: `cast call $EXECUTOR_ADDRESS "isAdapterApproved(address)(bool)" <ADAPTER_ADDRESS> --rpc-url $RPC_URL`
- `NotAuthorized()` → bot wallet is not the botWallet on the contract. Run: `cast call $EXECUTOR_ADDRESS "botWallet()" --rpc-url $RPC_URL`
- `ContractPaused()` → circuit breaker tripped. Run: `cast call $EXECUTOR_ADDRESS "paused()" --rpc-url $RPC_URL` — if true, call `unpause()` from owner wallet
- `InsufficientProfit(received, required)` → flash loan amount is too small to clear the profit floor. Consider lowering MIN_PROFIT_WEI.

**Note on accuracy:** Shadow mode's `simulateTransaction()` returns `{success: boolean}` only. The eth_call does NOT decode the `ArbitrageExecuted` event profit amount from the return data. The estimated profit shown in logs is from the off-chain detection pipeline, not from simulation. A successful simulation means the transaction would not revert — it does NOT prove the estimated profit is exact. A > 50% pass rate is sufficient to validate the pipeline wiring.
  </action>
  <verify>
100+ opportunities have been detected and simulated. Simulation pass rate is above 50% (count successes vs failures). No single revert reason accounts for 100% of failures (would indicate systematic misconfiguration). Type "shadow validated" with a brief summary: total simulations, pass count, failure count, and most common failure reason (if any).
  </verify>
  <done>Shadow mode validated: more than 50% of profitable opportunities simulate successfully via eth_call over 100+ attempts. No systematic revert pattern indicating contract misconfiguration. Pipeline is healthy and ready for live mode.</done>
</task>

</tasks>

<verification>
1. Bot ran in SHADOW mode for sufficient time to accumulate 100+ detected opportunities
2. Simulation pass rate exceeded 50% (most opportunities would succeed on-chain)
3. No single revert reason accounts for all failures (no systematic wiring error)
4. No startup guard failures (EXECUTOR_ADDRESS was correctly set, bot initialized cleanly)
5. Camelot opportunities (if any) were skipped cleanly by the zero-address adapter guard, not sent as bad transactions
</verification>

<success_criteria>
Shadow mode validates that the deployed contracts are correctly wired: adapters registered, executor authorized, flash loan providers connected. The > 50% simulation pass rate demonstrates that the detection pipeline produces genuinely executable opportunities. The pipeline is ready for live execution.
</success_criteria>

<output>
After completion, create `/Users/naynay/Projects/personal/feat.web-sockets/.planning/phases/12-contract-deployment-live-validation/12-02-SUMMARY.md`
</output>
