---
phase: 12-contract-deployment-live-validation
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified: []
autonomous: false
requirements: [EXEC-02]

must_haves:
  truths:
    - "Bot runs in shadow mode on Arbitrum mainnet, simulating trades via eth_call without broadcasting"
    - "Shadow mode logs estimated vs simulated profit for each opportunity"
    - "At least 100 opportunities have been validated with estimated vs simulated profit comparison"
    - "Estimated and simulated profits match within 10% for the majority of opportunities"
  artifacts: []
  key_links:
    - from: "bot/src/run-arb-mainnet.ts"
      to: "FlashloanExecutor (deployed)"
      via: "EXECUTOR_ADDRESS env var"
    - from: "bot/src/index.ts (shadow mode)"
      to: "eth_call simulation"
      via: "ExecutionEngine.simulateTransaction()"
---

<objective>
Run the bot in shadow mode against Arbitrum mainnet to validate that profit estimates from the detection pipeline match eth_call simulation results, building confidence before live trading.

Purpose: Verify that the entire pipeline (price monitoring -> opportunity detection -> cost estimation -> transaction building -> simulation) produces accurate results before spending real gas.
Output: Shadow mode logs showing estimated vs simulated profit alignment for 100+ opportunities.
</objective>

<execution_context>
@/Users/naynay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naynay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-live-execution-safety/07-01-SUMMARY.md
@.planning/phases/07-live-execution-safety/07-03-SUMMARY.md
@bot/src/run-arb-mainnet.ts
@bot/src/index.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure and launch shadow mode</name>
  <action>
Set up the bot to run in shadow mode with the deployed contract addresses.

**1. Set environment variables:**
```bash
# RPC endpoint
export RPC_URL="<your Arbitrum RPC URL>"

# Execution mode: shadow (simulates via eth_call, no gas spent)
export DRY_RUN="false"
export SHADOW_MODE="true"

# Wallet for signing simulations (same deployer wallet)
export PRIVATE_KEY="<your deployer private key>"

# Deployed contract addresses (from deployments/42161.json or Plan 12-01 output)
export EXECUTOR_ADDRESS="<FlashloanExecutor address from deployment>"

# Adapter addresses (from deployments/42161.json)
export ADAPTER_UNISWAP_V3="<UniswapV3Adapter address>"
export ADAPTER_SUSHISWAP="<SushiSwapV2Adapter address>"
export ADAPTER_TRADERJOE_LB="<TraderJoeLBAdapter address>"

# Optional: adapters not deployed (leave unset or set to zero address)
# ADAPTER_UNISWAP_V2 — not deployed (no Uniswap V2 on Arbitrum)
# ADAPTER_SUSHISWAP_V3 — not deployed (skipped)
# ADAPTER_CAMELOT_V2 — not deployed
# ADAPTER_CAMELOT_V3 — not deployed
```

**2. Verify the addresses are correct:**
```bash
# Should return the deployer/owner address
cast call $EXECUTOR_ADDRESS "owner()" --rpc-url $RPC_URL

# Should return the bot wallet address
cast call $EXECUTOR_ADDRESS "botWallet()" --rpc-url $RPC_URL
```

**3. Launch the bot in shadow mode:**
```bash
cd bot
node --import tsx src/run-arb-mainnet.ts
```

**Expected startup output:**
```
  Flashloan Bot v1.1.0 — ARBITRUM ONE
  Mode:     SHADOW
  Chain:    Arbitrum One (chainId 42161)
  RPC:      configured
  Pools:    XX configured
```

The bot will:
- Monitor all configured Arbitrum pools for price deltas
- When an opportunity is found, build a transaction via TransactionBuilder
- Simulate the transaction via `eth_call` (free, no gas)
- Log: "Simulation succeeded — estimated: X ETH, simulated: Y ETH" or "Simulation failed — reason: ..."
  </action>
  <verify>
Bot starts in SHADOW mode (check startup banner). No errors in the first 60 seconds of operation. Price updates are being logged. When the first opportunity is found, a simulation log line appears (either success or failure).
  </verify>
  <done>Bot running in shadow mode on Arbitrum mainnet, monitoring pools and simulating opportunities via eth_call.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Validate shadow mode results over 100+ opportunities</name>
  <action>
Let the bot run for several hours (4-8 hours recommended for 100+ opportunities).

Shadow mode validation is running on Arbitrum mainnet, simulating opportunities via eth_call.

**Monitor the logs for:**

1. **Simulation successes:** Lines containing "Simulation succeeded" with estimated vs simulated profit.
   - Compare estimated and simulated values. They should match within 10%.
   - Formula: `|estimated - simulated| / max(estimated, simulated) < 0.10`

2. **Simulation failures:** Lines containing "Simulation failed" with revert reasons.
   - Some failures are expected (stale prices, frontrunning, pool state changes).
   - If >50% of simulations fail, there may be a systematic issue (wrong adapter address, contract configuration error).

3. **Opportunity count:** Track total opportunities found vs simulated.
   - Goal: 100+ opportunities simulated.

**If running via pm2:**
```bash
# Start with pm2 for unattended operation
pm2 start ecosystem.config.cjs

# Watch logs
pm2 logs flashloan-bot --lines 100

# Check status
pm2 status
```

**After reaching 100+ opportunities, analyze results:**
```bash
# Count simulation successes vs failures (grep the pm2 log or stdout)
grep -c "Simulation succeeded" <log-file>
grep -c "Simulation failed" <log-file>

# Check estimation accuracy (look for estimated vs simulated values)
grep "Simulation succeeded" <log-file> | tail -20
```

**If accuracy is poor (>10% divergence):**
- Check if gas estimation is off (L1 data fee component)
- Check if slippage estimates are inaccurate
- Check adapter addresses match deployed contracts
  </action>
  <verify>
100+ opportunities simulated. Estimation accuracy within 10% for the majority of successful simulations. No systematic failures (e.g., all simulations reverting with the same error). Type "shadow validated" with a summary of results (opportunity count, accuracy, failure rate), or describe issues found.
  </verify>
  <done>Shadow mode validated: estimated vs simulated profits match within 10% across 100+ opportunities.</done>
</task>

</tasks>

<verification>
1. Bot ran in SHADOW mode for multiple hours on Arbitrum mainnet
2. At least 100 opportunities were detected and simulated via eth_call
3. Estimated vs simulated profits match within 10% for the majority of successful simulations
4. No systematic simulation failures (all reverting with same error)
5. Bot operated stably without crashes during the shadow period
</verification>

<success_criteria>
Shadow mode has validated that the detection pipeline's profit estimates are accurate (within 10% of eth_call simulation results) across 100+ opportunities. This provides confidence that live trades will be profitable as estimated.
</success_criteria>

<output>
After completion, create `.planning/phases/12-contract-deployment-live-validation/12-02-SUMMARY.md`
</output>
